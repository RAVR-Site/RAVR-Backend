# RAVR Backend

Backend-сервис на Go для проекта RAVR с поддержкой полного CI/CD пайплайна, системы миграций и Swagger документации.

## Структура проекта

- `cmd/` — точка входа (main.go) с метаданными Swagger
- `config/` — конфигурация приложения с автозагрузкой переменных окружения
- `internal/` — бизнес-логика, контроллеры, сервисы, репозитории, хранилища
- `docs/` — автогенерируемая Swagger документация
- `migrations/` — SQL-файлы миграций для базы данных
- `data/` — статические данные и ресурсы приложения
- `Dockerfile` — многоступенчатая сборка Docker-образа с автогенерацией Swagger
- `docker-compose.yml` — оркестрация всех сервисов с зависимостями
- `Makefile` — расширенный набор команд для разработки и деплоя

## Быстрый старт

### Локальный запуск

```bash
make build      # Сборка бинарника
make run        # Запуск приложения
```

### Тесты и линтинг

```bash
make test       # Запуск тестов с coverage
make test-jwt   # Запуск только JWT-связанных тестов  
make test-integration  # Запуск интеграционных тестов
make lint       # Проверка линтером (golangci-lint)
```

### Docker-окружение

```bash
make docker-build   # Сборка Docker-образа
make up             # Запуск полного стека (БД + миграции + приложение)
make up-infra       # Запуск только базы данных и применение миграций
make down           # Остановка всех сервисов
```

### Система миграций

В проекте используется golang-migrate для управления миграциями базы данных с полной поддержкой версионирования.

```bash
# Создание новой миграции (интерактивно)
make migrate-create

# Применение всех неприменённых миграций
export DATABASE_DSN="postgres://postgres:postgres@localhost:5432/ravr-backend?sslmode=disable"
make migrate

# Откат последней миграции
make migrate-down

# Полное удаление всех миграций (осторожно!)
make migrate-drop

# Сброс и повторное применение всех миграций
make migrate-reset

# Проверка текущей версии схемы БД
make migrate-version
```

### Очистка

```bash
make clean     # Удаление скомпилированных файлов
```

## Архитектура проекта

Проект построен с использованием принципов чистой архитектуры (Clean Architecture):

- `controller/` — HTTP-обработчики и роутинг
- `service/` — бизнес-логика и правила
- `repository/` — слой доступа к данным
- `database/` — управление соединениями и миграциями
- `storage/` — файловое хранилище и обработка медиа
- `auth/` — JWT менеджер и система авторизации
- `middleware/` — промежуточное ПО для аутентификации и логирования

Все слои изолированы друг от друга через интерфейсы, что обеспечивает легкость тестирования и поддержки.

## Система авторизации

Проект включает продвинутую систему JWT авторизации с комплексными улучшениями безопасности:

### Основные возможности

- **JWT токены** — безопасная аутентификация с настраиваемым временем жизни
- **Структурированные Claims** — стандартные JWT поля (iss, sub, iat, exp, nbf)
- **Централизованное управление** — dedicated JWTManager для генерации и валидации токенов
- **Конфигурируемость** — настройка времени жизни токенов через переменные окружения
- **Валидация издателя** — проверка issuer и not-before для дополнительной безопасности

### Документация

Подробная документация JWT системы доступна в отдельном файле:
- [JWT Authorization Documentation](docs/JWT_AUTHORIZATION.md) — полное руководство по JWT системе
- [JWT System Status](JWT_SYSTEM_STATUS.md) — текущий статус и результаты тестирования

### Безопасность

- Криптографически стойкий 256-битный JWT секрет
- Время жизни токена по умолчанию: 24 часа (настраивается)
- Полная валидация всех JWT полей
- Расширенное логирование и обработка ошибок

## CI/CD Pipeline

Проект включает полноценный Go CI/CD пайплайн с несколькими этапами:

### Автоматические проверки

- **Линтинг** — golangci-lint с таймаутом 5 минут
- **Тестирование** — полный набор тестов с race detection и coverage
- **JWT Тестирование** — комплексные тесты JWT системы авторизации
- **Интеграционные тесты** — end-to-end тестирование с in-memory базой данных
- **Сборка** — кроссплатформенная компиляция
- **Security** — статический анализ кода через Semgrep

### Валидация инфраструктуры

- **Миграции** — автоматическая проверка применения и отката на PostgreSQL 16
- **Swagger** — валидация актуальности API документации

### Деплой и доставка

- **Docker** — автоматическая сборка и пуш образов в Docker Hub
- **Мультитегирование** — поддержка semantic versioning, SHA и latest тегов
- **Кеширование** — оптимизация сборки через GitHub Actions cache

## Docker-инфраструктура

Проект включает три основных контейнера с правильной последовательностью запуска:

1. **db** — PostgreSQL 16 база данных
2. **migrator** — сервис автоматического применения миграций
3. **app** — основной сервис приложения

Docker Compose настроен с dependency management — приложение запускается только после успешного применения всех
миграций.

## Требования

### Обязательные

- Go 1.24.2+
- Docker & Docker Compose
- golang-migrate (для локальной работы с миграциями)

### Для разработки

- golangci-lint (автоматическая установка в CI/CD)
- swag (автоматическая установка при сборке Docker)

## Переменные окружения

Создайте файл `.env` или установите переменные окружения:

### Основные

- `DATABASE_DSN` — строка подключения к PostgreSQL
- `JWT_SECRET` — секретный ключ для JWT токенов (рекомендуется 256-битный)
- `JWT_ACCESS_EXPIRATION` — время жизни JWT токена (по умолчанию 24h)
- `JWT_ISSUER` — издатель JWT токенов (по умолчанию ravr-backend)
- `PORT` — порт HTTP сервера (по умолчанию 8080)

### Генерация JWT секрета

Для генерации криптографически стойкого JWT секрета используйте:

```bash
make generate-jwt-secret
```

Или запустите утилиту напрямую:

```bash
go run tools/generate-jwt-secret/main.go
```

### Docker

- `DB_HOST` — хост базы данных (по умолчанию localhost для локальной разработки)

### CI/CD (Secrets)

- `DOCKER_USERNAME` — логин Docker Hub для автоматического пуша образов
- `DOCKER_PASSWORD` — пароль Docker Hub
- `SEMGREP_APP_TOKEN` — токен для статического анализа безопасности

## Документация API

Swagger документация автоматически генерируется из аннотаций в коде:

### В режиме разработки

- `GET /swagger/*` — интерактивный Swagger UI
- `GET /swagger/doc.json` — JSON спецификация OpenAPI 3.0

### Файлы документации

- `docs/swagger.json` — JSON спецификация для интеграций
- `docs/swagger.yaml` — YAML спецификация для ручного просмотра

### Метаданные API

- **Версия**: 1.0
- **Base Path**: `/api/v1`
- **Аутентификация**: Bearer JWT токены через заголовок `Authorization`
- **Контакты**: support@ravr-site.io

Документация автоматически обновляется при изменении аннотаций в коде и проверяется в CI/CD пайплайне.

## Дополнительная документация

- [JWT Authorization](docs/JWT_AUTHORIZATION.md) — подробное руководство по JWT системе авторизации
- [JWT System Status](JWT_SYSTEM_STATUS.md) — текущий статус JWT системы и результаты тестирования
- [API Documentation](docs/) — автогенерируемая Swagger документация

## Структура тестирования

Проект включает многоуровневую систему тестирования:

### Unit тесты
- JWT Manager тесты — проверка генерации и валидации токенов
- User Service тесты — тестирование бизнес-логики авторизации
- Controller тесты — проверка HTTP обработчиков

### Интеграционные тесты
- End-to-end JWT flow — полный цикл регистрации, авторизации и доступа к защищенным эндпоинтам
- Database integration — тестирование с in-memory SQLite базой данных
- Middleware testing — проверка JWT middleware в реальных условиях

### Coverage
Текущее покрытие тестами: JWT система — 100%, общее покрытие проекта проверяется в CI/CD.

---

*Этот README автоматически поддерживается в актуальном состоянии в соответствии с изменениями в проекте.*