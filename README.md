# RAVR Backend

Backend-сервис на Go для проекта RAVR с поддержкой полного CI/CD пайплайна, системы миграций и Swagger документации.

## Структура проекта

- `cmd/` — точка входа (main.go) с метаданными Swagger
- `config/` — конфигурация приложения с автозагрузкой переменных окружения
- `internal/` — бизнес-логика, контроллеры, сервисы, репозитории, хранилища
- `docs/` — автогенерируемая Swagger документация
- `migrations/` — SQL-файлы миграций для базы данных
- `data/` — статические данные и ресурсы приложения
- `Dockerfile` — многоступенчатая сборка Docker-образа с автогенерацией Swagger
- `docker-compose.yml` — оркестрация всех сервисов с зависимостями
- `Makefile` — расширенный набор команд для разработки и деплоя

## Быстрый старт

### Локальный запуск

```bash
make build      # Сборка бинарника
make run        # Запуск приложения
```

### Тесты и линтинг

```bash
make test       # Запуск тестов с coverage
make lint       # Проверка линтером (golangci-lint)
```

### Docker-окружение

```bash
make docker-build   # Сборка Docker-образа
make up             # Запуск полного стека (БД + миграции + приложение)
make up-infra       # Запуск только базы данных и применение миграций
make down           # Остановка всех сервисов
```

### Система миграций

В проекте используется golang-migrate для управления миграциями базы данных с полной поддержкой версионирования.

```bash
# Создание новой миграции (интерактивно)
make migrate-create

# Применение всех неприменённых миграций
export DATABASE_DSN="postgres://postgres:postgres@localhost:5432/ravr-backend?sslmode=disable"
make migrate

# Откат последней миграции
make migrate-down

# Полное удаление всех миграций (осторожно!)
make migrate-drop

# Сброс и повторное применение всех миграций
make migrate-reset

# Проверка текущей версии схемы БД
make migrate-version
```

### Очистка

```bash
make clean     # Удаление скомпилированных файлов
```

## Архитектура проекта

Проект построен с использованием принципов чистой архитектуры (Clean Architecture):

- `controller/` — HTTP-обработчики и роутинг
- `service/` — бизнес-логика и правила
- `repository/` — слой доступа к данным
- `database/` — управление соединениями и миграциями
- `storage/` — файловое хранилище и обработка медиа

Все слои изолированы друг от друга через интерфейсы, что обеспечивает легкость тестирования и поддержки.

## CI/CD Pipeline

Проект включает полноценный Go CI/CD пайплайн с несколькими этапами:

### Автоматические проверки

- **Линтинг** — golangci-lint с таймаутом 5 минут
- **Тестирование** — полный набор тестов с race detection и coverage
- **Сборка** — кроссплатформенная компиляция
- **Security** — статический анализ кода через Semgrep

### Валидация инфраструктуры

- **Миграции** — автоматическая проверка применения и отката на PostgreSQL 16
- **Swagger** — валидация актуальности API документации

### Деплой и доставка

- **Docker** — автоматическая сборка и пуш образов в Docker Hub
- **Мультитегирование** — поддержка semantic versioning, SHA и latest тегов
- **Кеширование** — оптимизация сборки через GitHub Actions cache

## Docker-инфраструктура

Проект включает три основных контейнера с правильной последовательностью запуска:

1. **db** — PostgreSQL 16 база данных
2. **migrator** — сервис автоматического применения миграций
3. **app** — основной сервис приложения

Docker Compose настроен с dependency management — приложение запускается только после успешного применения всех
миграций.

## Требования

### Обязательные

- Go 1.24.2+
- Docker & Docker Compose
- golang-migrate (для локальной работы с миграциями)

### Для разработки

- golangci-lint (автоматическая установка в CI/CD)
- swag (автоматическая установка при сборке Docker)

## Переменные окружения

Создайте файл `.env` или установите переменные окружения:

### Основные

- `DATABASE_DSN` — строка подключения к PostgreSQL
- `JWT_SECRET` — секретный ключ для JWT токенов
- `PORT` — порт HTTP сервера (по умолчанию 8080)

### Docker

- `DB_HOST` — хост базы данных (по умолчанию localhost для локальной разработки)

### CI/CD (Secrets)

- `DOCKER_USERNAME` — логин Docker Hub для автоматического пуша образов
- `DOCKER_PASSWORD` — пароль Docker Hub
- `SEMGREP_APP_TOKEN` — токен для статического анализа безопасности

## Документация API

Swagger документация автоматически генерируется из аннотаций в коде:

### В режиме разработки

- `GET /swagger/*` — интерактивный Swagger UI
- `GET /swagger/doc.json` — JSON спецификация OpenAPI 3.0

### Файлы документации

- `docs/swagger.json` — JSON спецификация для интеграций
- `docs/swagger.yaml` — YAML спецификация для ручного просмотра

### Метаданные API

- **Версия**: 1.0
- **Base Path**: `/api/v1`
- **Аутентификация**: Bearer JWT токены через заголовок `Authorization`
- **Контакты**: support@ravr-site.io

Документация автоматически обновляется при изменении аннотаций в коде и проверяется в CI/CD пайплайне.

---

*Этот README автоматически поддерживается в актуальном состоянии в соответствии с изменениями в проекте.*